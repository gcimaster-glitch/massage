# 📧 メール通知とStripe決済の設定ガイド

## 🔑 必要なAPIキー

HOGUSYを本番環境で動作させるには、以下のAPIキーが必要です：

### 1. **Resend API Key**（メール送信）
- **用途**: 予約確定・キャンセル・KYC審査結果のメール通知
- **取得方法**: https://resend.com/
- **環境変数名**: `RESEND_API_KEY`

### 2. **Stripe Secret Key**（決済）
- **用途**: クレジットカード決済処理
- **取得方法**: https://stripe.com/
- **環境変数名**: `STRIPE_SECRET`

---

## 🛠️ Cloudflare Pages での環境変数設定（詳細版）

### **前提条件**
- Cloudflareアカウントを持っている
- `hogusy` プロジェクトがデプロイ済み
- Resend APIキー（`re_...`）を取得済み
- Stripe Secret Key（`sk_test_...` または `sk_live_...`）を取得済み

---

### **ステップ1: Cloudflare Dashboardにアクセス**

#### **1-1. ログイン**
1. ブラウザで https://dash.cloudflare.com/ にアクセス
2. メールアドレスとパスワードでログイン
3. ⚠️ 2段階認証が有効な場合、認証コードを入力

#### **1-2. Workers & Pages に移動**
1. ダッシュボード画面の**左サイドバー**を確認
2. **Workers & Pages** をクリック
   - 見つからない場合：画面上部の検索バーで「Workers」と検索
3. プロジェクト一覧が表示される

#### **1-3. hogusy プロジェクトを選択**
1. プロジェクト一覧から **hogusy** をクリック
2. プロジェクトの概要画面が表示される
3. 画面上部に以下のタブが表示されます：
   - **Deployments**（デプロイ履歴）
   - **Settings**（設定）← ここをクリック
   - **Functions**
   - **Analytics**

---

### **ステップ2: Environment Variables（環境変数）を設定**

#### **2-1. Settings ページに移動**
1. 画面上部の **Settings** タブをクリック
2. 左サイドバーに設定項目が表示される
3. **Environment variables** をクリック

#### **2-2. 環境変数の画面を確認**
画面に以下のセクションが表示されます：

- **Production**（本番環境）
- **Preview**（プレビュー環境）

**どちらに設定すべき？**
- ✅ **Production**: 本番環境（`hogusy.pages.dev` と独自ドメイン）
- 🔲 **Preview**: プレビュー環境（プルリクエストのプレビュー）

**推奨**: まず **Production** に設定し、動作確認後に **Preview** にもコピー

---

### **ステップ3: RESEND_API_KEY を追加**

#### **3-1. 変数を追加**
1. **Production** セクションの **Add variable** ボタンをクリック
2. ダイアログが表示される

#### **3-2. 変数の詳細を入力**

**Variable name（変数名）:**
```
RESEND_API_KEY
```
- ⚠️ **大文字・小文字を正確に入力**してください
- ⚠️ **スペースを入れない**でください
- ⚠️ **アンダースコア（`_`）を忘れない**でください

**Value（値）:**
```
re_123abc456def789ghi012jkl345mno678pqr
```
- Resendダッシュボードで取得したAPIキーを**そのままコピー＆ペースト**
- ⚠️ **前後にスペースを入れない**でください
- ⚠️ **`re_` から始まるか確認**してください

**Environment（環境）:**
- ✅ **Production** を選択
- 🔲 **Preview** は後で追加可能

**Type（タイプ）:**
- ✅ **Encrypted**（暗号化）を選択（デフォルト）
- これにより、APIキーが安全に保存されます

#### **3-3. 保存**
1. **Save** ボタンをクリック
2. 画面に戻ると、変数が追加されていることを確認
3. 値は `••••••••` のように表示される（セキュリティのため）

---

### **ステップ4: STRIPE_SECRET を追加**

#### **4-1. 変数を追加**
1. 同じく **Add variable** ボタンをクリック

#### **4-2. 変数の詳細を入力**

**Variable name（変数名）:**
```
STRIPE_SECRET
```

**Value（値）:**
- **テストモードの場合**:
  ```
  sk_test_51Abc123...xyz
  ```
- **本番モードの場合**:
  ```
  sk_live_51Abc123...xyz
  ```

**注意点:**
- ⚠️ **テストモードと本番モードを混同しない**
- ⚠️ **`sk_test_` または `sk_live_` から始まるか確認**
- ✅ 最初は**テストモード**（`sk_test_`）で設定することを推奨

**Environment（環境）:**
- ✅ **Production** を選択

**Type（タイプ）:**
- ✅ **Encrypted**（暗号化）を選択

#### **4-3. 保存**
1. **Save** ボタンをクリック
2. 画面に2つの環境変数が表示されることを確認：
   - `RESEND_API_KEY` = `••••••••`
   - `STRIPE_SECRET` = `••••••••`

---

### **ステップ5: 環境変数の確認**

#### **5-1. 変数一覧を確認**
画面に以下のように表示されます：

| Variable name      | Environment | Type      | Value    | Actions |
|--------------------|-------------|-----------|----------|---------|
| RESEND_API_KEY     | Production  | Encrypted | ••••••••| Edit    |
| STRIPE_SECRET      | Production  | Encrypted | ••••••••| Edit    |

#### **5-2. 編集する場合**
1. 右側の **Edit** ボタンをクリック
2. 値を修正
3. **Save** をクリック

#### **5-3. 削除する場合**
1. 右側の **三点メニュー（︙）** をクリック
2. **Delete** を選択
3. 確認ダイアログで **Delete** をクリック

---

### **ステップ6: プロジェクトを再デプロイ**

#### **なぜ再デプロイが必要？**
- 環境変数は**デプロイ時**にアプリケーションに組み込まれる
- 環境変数を追加・変更した後は、**必ず再デプロイ**が必要

#### **6-1. 再デプロイの方法（2つ）**

**方法1: Cloudflare Dashboardから再デプロイ**
1. プロジェクトページの **Deployments** タブをクリック
2. 最新のデプロイメントの右側にある **三点メニュー（︙）** をクリック
3. **Retry deployment** を選択
4. 数分待つとデプロイが完了

**方法2: ローカルから再デプロイ（推奨）**
```bash
cd /home/user/webapp
npm run build
npx wrangler pages deploy dist --project-name hogusy
```

#### **6-2. デプロイ完了を確認**
1. デプロイが完了すると、新しいURLが表示される
   ```
   ✨ Deployment complete!
   Take a peek over at https://abc123.hogusy.pages.dev
   ```
2. このURLにアクセスして動作確認

---

### **ステップ7: 動作確認**

#### **7-1. メール送信のテスト**
1. 本番環境（`https://hogusy.com` または最新デプロイURL）にアクセス
2. 予約を作成して決済を完了
3. 数分以内にメールが届くか確認
4. ✅ **予約確定メール**が届けば成功！

#### **7-2. メール送信ログの確認**
1. Resendダッシュボードにアクセス
2. 左サイドバーの **Logs** をクリック
3. 送信されたメールの履歴を確認
4. ステータスが **Delivered**（配信済み）になっているか確認

#### **7-3. エラーが発生した場合**
1. Cloudflare Dashboardの **Deployments** → **最新デプロイ** → **Logs** を確認
2. エラーメッセージを確認
3. 環境変数が正しく設定されているか再確認

---

### **よくあるエラーと対処法**

#### **エラー1: `RESEND_API_KEY is not defined`**
- **原因**: 環境変数が設定されていない
- **対処法**:
  1. Cloudflare Dashboardで環境変数を確認
  2. 変数名が正確に `RESEND_API_KEY` か確認（大文字・小文字・スペース）
  3. 再デプロイを実行

#### **エラー2: `Invalid API key`**
- **原因**: APIキーが間違っている
- **対処法**:
  1. Resendダッシュボードで新しいAPIキーを生成
  2. Cloudflareの環境変数を更新
  3. 再デプロイを実行

#### **エラー3: `Email delivery failed`**
- **原因**: 送信先メールアドレスが無効
- **対処法**:
  1. メールアドレスのスペルを確認
  2. Resendの Logs でエラー詳細を確認
  3. ドメイン認証が完了しているか確認

#### **エラー4: メールが届かない**
- **原因**: スパムフォルダに振り分けられている
- **対処法**:
  1. 迷惑メールフォルダを確認
  2. ドメイン認証を完了させる（SPF/DKIM/DMARC）
  3. Resendの Logs で配信ステータスを確認

---

### **セキュリティのベストプラクティス**

#### **1. APIキーを定期的にローテーション**
- 3〜6ヶ月ごとに新しいAPIキーを生成
- 古いAPIキーを削除

#### **2. 環境ごとに異なるAPIキーを使用**
- 本番環境: `HOGUSY Production`
- ステージング環境: `HOGUSY Staging`
- 開発環境: `HOGUSY Dev`

#### **3. 最小権限の原則**
- 本番環境では **Sending Access** のみを許可
- **Full Access** は開発環境のみ

#### **4. アクセスログを定期的に確認**
- Resendダッシュボードで送信履歴を確認
- 不審なアクティビティがないか監視

---

## 🧪 ローカル開発環境での設定（`.dev.vars`）

ローカル開発環境で動作確認するには、`.dev.vars`ファイルを作成します：

### **1. .dev.varsファイルを作成**
```bash
cd /home/user/webapp
touch .dev.vars
```

### **2. APIキーを記述**
```bash
# .dev.vars
RESEND_API_KEY=re_your_resend_api_key_here
STRIPE_SECRET=sk_test_your_stripe_test_key_here
```

### **3. .gitignoreに追加（重要！）**
`.dev.vars`は既に`.gitignore`に含まれているはずですが、念のため確認してください：

```bash
# .gitignore
.dev.vars
```

### **4. ローカルで起動**
```bash
npm run build
npx wrangler pages dev dist --local
```

---

## 📧 Resend APIキーの取得方法（詳細版）

### **ステップ1: Resendにサインアップ**
1. ブラウザで https://resend.com/ にアクセス
2. 右上の **Sign Up** ボタンをクリック
3. 以下のいずれかの方法でアカウントを作成：
   - **GitHub アカウント**で連携（推奨）
   - **Email** と **Password** で登録
4. メールアドレスに確認メールが届くので、リンクをクリックして認証

---

### **ステップ2: APIキーを生成（重要！）**

#### **2-1. API Keys ページに移動**
1. ログイン後、左サイドバーの **API Keys** をクリック
2. 画面右上の **+ Create API Key** ボタンをクリック

#### **2-2. APIキーの設定を入力**

**Name（名前）:**
- **入力例**: `HOGUSY Production`
- **説明**: このAPIキーの用途を識別するための名前
- **推奨**: 環境ごとに分ける（例：`HOGUSY Dev`、`HOGUSY Staging`、`HOGUSY Production`）

**Permission（権限）:**
- **選択肢**:
  - **Full Access** - すべての操作が可能（推奨）
  - **Sending Access** - メール送信のみ
  - **Read Access** - 読み取りのみ
- **本番環境では**: **Sending Access** を推奨（セキュリティのため）
- **開発環境では**: **Full Access** でOK

**Domain（ドメイン）:**
- **初回の場合**: 空欄でOK（デフォルトドメインを使用）
- **独自ドメインを設定済みの場合**: `hogusy.com` を選択

#### **2-3. APIキーを生成**
1. **Create** ボタンをクリック
2. 画面に **APIキー**（`re_xxxxxxxx...`）が表示される
3. ⚠️ **この画面は1回しか表示されません！** 必ずコピーして保存してください

**APIキーの例:**
```
re_123abc456def789ghi012jkl345mno678pqr
```

#### **2-4. APIキーを安全に保存**
- ❌ **GitHubにコミットしない**
- ❌ **Slackなどのチャットに貼らない**
- ✅ **パスワードマネージャーに保存**（1Password、Bitwarden など）
- ✅ **Cloudflare環境変数に直接設定**

---

### **ステップ3: ドメイン認証（オプション・推奨）**

#### **なぜドメイン認証が必要？**
- デフォルトでは `onboarding@resend.dev` からメール送信
- 独自ドメイン（`noreply@hogusy.com`）から送信するには認証が必要
- **メール到達率が向上**（スパム判定されにくい）

#### **3-1. ドメインを追加**
1. 左サイドバーの **Domains** をクリック
2. **+ Add Domain** ボタンをクリック
3. **Domain name** に `hogusy.com` を入力
4. **Region** で `Global` を選択（デフォルト）
5. **Add** をクリック

#### **3-2. DNS設定を追加**
画面に以下のような**DNSレコード**が表示されます：

**SPFレコード（必須）:**
```
Type: TXT
Name: @
Value: v=spf1 include:amazonses.com ~all
```

**DKIMレコード1（必須）:**
```
Type: CNAME
Name: resend._domainkey
Value: resend._domainkey.hogusy.com.resend.com
```

**DKIMレコード2（必須）:**
```
Type: CNAME
Name: resend2._domainkey
Value: resend2._domainkey.hogusy.com.resend.com
```

**DMARCレコード（オプション・推奨）:**
```
Type: TXT
Name: _dmarc
Value: v=DMARC1; p=none; rua=mailto:admin@hogusy.com
```

#### **3-3. Cloudflare DNSに設定**
1. https://dash.cloudflare.com/ にログイン
2. `hogusy.com` ドメインをクリック
3. 左サイドバーの **DNS** → **Records** をクリック
4. **Add record** ボタンをクリック
5. 上記のDNSレコードを1つずつ追加

#### **3-4. 認証を確認**
1. Resendのダッシュボードに戻る
2. **Domains** ページで `hogusy.com` の横に **Verify** ボタンをクリック
3. 認証が成功すると ✅ **Verified** と表示される
4. ⚠️ DNS反映には **最大48時間**かかる場合があります

**認証が完了すると:**
- `noreply@hogusy.com` からメール送信可能
- `support@hogusy.com` などの独自メールアドレスも使用可能

---

### **トラブルシューティング**

#### **APIキーが表示されない**
- ブラウザの拡張機能（広告ブロッカー）を無効にする
- シークレットモード/プライベートウィンドウで試す
- 別のブラウザで試す

#### **ドメイン認証が失敗する**
- DNSレコードが正しく設定されているか確認
- DNS反映を待つ（最大48時間）
- Cloudflare Proxyをオフにする（DNSレコードの雲マークをグレーにする）

#### **メールが送信されない**
- APIキーが正しく設定されているか確認
- Resendダッシュボードの **Logs** で送信履歴を確認
- 送信先メールアドレスが正しいか確認

---

## 💳 Stripe APIキーの取得方法（詳細版）

### **ステップ1: Stripeアカウントを作成**

#### **1-1. Stripeにアクセス**
1. ブラウザで https://stripe.com/jp にアクセス
2. 右上の **今すぐ始める** ボタンをクリック

#### **1-2. アカウント情報を入力**
**メールアドレス:**
- ビジネス用のメールアドレスを推奨（例：`admin@hogusy.com`）

**パスワード:**
- 8文字以上
- 大文字・小文字・数字を含む

**国/地域:**
- **日本** を選択

#### **1-3. メール認証**
1. 入力したメールアドレスに確認メールが届く
2. メール内の **メールアドレスを確認** リンクをクリック
3. Stripeダッシュボードにリダイレクトされる

---

### **ステップ2: ビジネス情報を入力（本番運用前に必須）**

#### **2-1. ビジネスの種類を選択**
- **個人事業主**
- **法人**（株式会社、合同会社など）
- **非営利団体**

#### **2-2. ビジネス情報を入力**
**法人の場合:**
- 会社名: `株式会社HOGUSY`
- 代表者名: `山田 太郎`
- 住所: `〒150-0002 東京都渋谷区渋谷1-1-1`
- 電話番号: `03-1234-5678`
- 設立年月日

**個人事業主の場合:**
- 屋号: `HOGUSY`
- 氏名: `山田 太郎`
- 生年月日
- 住所
- 電話番号

#### **2-3. 銀行口座情報を登録**
- 銀行名
- 支店名
- 口座番号
- 口座名義

⚠️ **注意**: 本番環境で決済を受け付けるには、この情報の登録が必須です。

---

### **ステップ3: テストモードでAPIキーを取得**

#### **3-1. Developers ページに移動**
1. Stripeダッシュボード（https://dashboard.stripe.com/）にログイン
2. 画面右上の **テスト環境** トグルを確認
   - 🟠 **テストモード**: オレンジ色のバッジが表示
   - 🔵 **本番モード**: 青色のバッジが表示
3. **テストモード**に切り替える（オレンジ色）
4. 画面右上の **開発者向け** または **Developers** をクリック
5. 左サイドバーの **API キー** をクリック

#### **3-2. テスト用のSecret Keyをコピー**
画面に以下の2種類のキーが表示されます：

**Publishable key（公開可能キー）:**
```
pk_test_51Abc123...xyz
```
- ⚠️ これは**使用しません**（フロントエンド用）

**Secret key（シークレットキー）:**
```
sk_test_51Abc123...xyz
```
- ✅ これを**コピー**します
- 🔒 **絶対に公開しないでください**

#### **3-3. Secret Keyを表示**
1. **Secret key** の行で **表示** または **Reveal test key** をクリック
2. キー全体が表示される
3. **コピー** アイコンをクリック、またはキー全体を選択してコピー
4. ⚠️ **この画面を閉じる前に必ずコピー**してください

---

### **ステップ4: 本番モードでAPIキーを取得（本番運用時）**

#### **4-1. アカウントをアクティベート**
1. ビジネス情報を完全に入力
2. 銀行口座情報を登録
3. 本人確認書類をアップロード
   - 運転免許証
   - パスポート
   - マイナンバーカード
4. Stripeの審査が完了するまで待つ（通常1〜3営業日）

#### **4-2. 本番モードに切り替え**
1. 審査完了後、画面右上の **テスト環境** トグルをクリック
2. **本番モード**（青色バッジ）に切り替わる
3. **Developers** → **API キー** に移動

#### **4-3. 本番用のSecret Keyをコピー**
**Secret key（本番）:**
```
sk_live_51Abc123...xyz
```
- ⚠️ **`sk_live_` から始まる**ことを確認
- ⚠️ **テストキーと混同しない**
- 🔒 **絶対に公開しないでください**

---

### **ステップ5: APIキーの管理**

#### **5-1. 制限付きキーの作成（推奨）**
セキュリティを強化するため、権限を制限したAPIキーを作成できます。

1. **API キー** ページで **+ 制限付きキーを作成** をクリック
2. **キー名**: `HOGUSY Production - Write Only`
3. **権限**:
   - ✅ **Charges**: Write（決済の作成）
   - ✅ **Customers**: Write（顧客の作成）
   - ✅ **PaymentIntents**: Write（支払いインテントの作成）
   - ❌ **Refunds**: No access（返金は管理画面から手動で）
4. **キーを作成** をクリック
5. 生成されたキーをコピー

#### **5-2. APIキーのローテーション**
定期的に新しいAPIキーを生成し、古いキーを削除します。

**手順:**
1. 新しいAPIキーを生成
2. Cloudflareの環境変数を新しいキーに更新
3. 再デプロイ
4. 動作確認後、古いAPIキーを削除

**推奨頻度:**
- 本番環境: 3〜6ヶ月ごと
- 開発環境: 必要に応じて

---

### **テストカード番号（開発用）**

テストモードでは、以下のカード番号を使用できます：

#### **成功するカード**
```
カード番号: 4242 4242 4242 4242
有効期限: 任意の未来の日付（例：12/25）
CVC: 任意の3桁（例：123）
郵便番号: 任意（例：100-0001）
```

#### **3Dセキュア認証が必要なカード**
```
カード番号: 4000 0027 6000 3184
```
- テストモードで3Dセキュア認証のフローをテスト可能

#### **決済が失敗するカード**
```
カード番号: 4000 0000 0000 0002
```
- エラーハンドリングをテスト可能

**その他のテストカード:**
- https://stripe.com/docs/testing#cards

---

### **Webhookの設定（オプション・推奨）**

#### **Webhookとは？**
- 決済が成功/失敗した際にStripeからサーバーに通知が送られる仕組み
- 決済の状態をリアルタイムで同期できる

#### **Webhookエンドポイントの設定**
1. **Developers** → **Webhook** をクリック
2. **+ エンドポイントを追加** をクリック
3. **エンドポイントURL**: `https://hogusy.com/api/stripe/webhook`
4. **リッスンするイベント**:
   - `payment_intent.succeeded`（決済成功）
   - `payment_intent.payment_failed`（決済失敗）
   - `charge.refunded`（返金）
5. **エンドポイントを追加** をクリック
6. **Signing secret**（`whsec_...`）をコピー
7. Cloudflareの環境変数 `STRIPE_WEBHOOK_SECRET` に設定

---

### **よくある質問**

#### **Q: テストモードと本番モードの違いは？**
- **テストモード**: 実際のお金は動かない。開発・テスト用。
- **本番モード**: 実際のお金が動く。実際の顧客からの決済を受け付ける。

#### **Q: APIキーを誤って公開してしまった**
1. すぐにStripeダッシュボードで該当のAPIキーを**削除**
2. 新しいAPIキーを生成
3. Cloudflareの環境変数を更新
4. 再デプロイ

#### **Q: 決済手数料はいくら？**
- 日本国内のカード: **3.6%**
- 海外のカード: **3.9%**
- 詳細: https://stripe.com/jp/pricing

#### **Q: 入金サイクルは？**
- デフォルト: **翌週の金曜日**
- 早期入金オプション: 申請可能（審査あり）

---

## ✅ 設定確認方法

### **1. 環境変数が設定されているか確認**
```bash
# Cloudflare Pages Dashboardで確認
# Settings → Environment variables
```

### **2. メール送信のテスト**
予約を確定すると、自動的にメールが送信されます。

### **3. Stripe決済のテスト**
テストモードでテストカード番号を使用：
- **カード番号**: `4242 4242 4242 4242`
- **有効期限**: 任意の未来の日付
- **CVC**: 任意の3桁

---

## 🚨 トラブルシューティング

### **メールが送信されない場合**
1. `RESEND_API_KEY` が正しく設定されているか確認
2. Resendダッシュボードで送信ログを確認
3. メールアドレスが正しいか確認
4. スパムフォルダを確認

### **Stripe決済が失敗する場合**
1. `STRIPE_SECRET` が正しく設定されているか確認
2. テストモード/本番モードが一致しているか確認
3. カード情報が正しいか確認
4. Stripeダッシュボードでログを確認

---

## 📞 サポート

問題が解決しない場合：
- **Resend**: https://resend.com/docs
- **Stripe**: https://stripe.com/docs

---

**設定が完了したら、次のコマンドで再デプロイしてください：**

```bash
cd /home/user/webapp
npm run build
npx wrangler pages deploy dist --project-name hogusy
```

これでメール通知と決済機能が本番環境で動作します！ 🎉
